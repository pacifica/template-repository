language: python
dist: bionic
services:
  - redis-server
  - postgresql

python:
  - 3.6
  - 3.7
  - 3.8

stages:
  - lint
  - test

env:
  BROKER_URL: redis://localhost:6379/0
  PEEWEE_URL: postgres://postgres:@localhost/pacifica_example

before_install:
  - psql -c 'create database pacifica_example;' -U postgres
script:
  - export EXAMPLE_CPCONFIG="$PWD/server.conf"
  - pip install .
  - cd tests
  - coverage run --include='*/pacifica/example/*' -m pytest -xsv
  - coverage report -m --fail-under 100

jobs:
  include:
    - stage: lint
      python: 3.6
      script: pre-commit run -a
    - python: 3.7
      script: pre-commit run -a
    - python: 3.8
      script: pre-commit run -a

install:
- pip install .
- pip install -r requirements-dev.txt
